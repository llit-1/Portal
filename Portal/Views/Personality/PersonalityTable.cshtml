@model Portal.Controllers.PersonalityController.PersonalityModelNew

@{
    var entityDict = (Model.entity ?? new List<Portal.Models.MSSQL.Personality.Entity>()).ToDictionary(x => x.Guid, x => x.Name);
}

<!--таблица пользователей-->
<div class="panel panel-default" id="personTable" style="margin-bottom:0px">
    <div class="panel-body">
        <div class="row mb-4 mt-3">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <table class="data-table nowrap" id="tableDataPerson">
                            <thead>
                                <tr>
                                    <th>Фамилия</th>
                                    <th>Имя</th>
                                    <th>Отчество</th>
                                    <th>Должность</th>
                                    <th>Место работы</th>
                                    <th class="">Дата приема на работу</th>
                                    <th class="">Дата увольнения</th>
                                    <th class="">ЮЛ</th>
                                    <th class="">ЮЛ разнесения затрат</th>
                                    <th>Активность</th>
                                </tr>
                            </thead>
                            <tbody id="tablePerson">
                            @foreach (var person in Model.personalityVersions)
                            {
                                <tr id="@person.Personalities.Guid"
                                    class="activeRow"
                                    style="@(person.Actual == 0 ? "background-color: rgba(243, 199, 160, 0.19);" : "")">

                                    <td class="tdPersonTable">
                                        <p class="list-item-heading">@person.Surname</p>
                                    </td>
                                    <td class="tdPersonTable">
                                        <p class="userName text-muted">@person.Name</p>
                                    </td>
                                    <td class="tdPersonTable">
                                        <p class="text-muted">@person.Patronymic</p>
                                    </td>
                                    <td class="tdPersonTable">
                                        @if (person.JobTitle?.Name == null)
                                        {
                                            <p class="text-muted">Парт-таймер</p>
                                        }
                                        else
                                        {
                                            <p class="text-muted">@person.JobTitle?.Name</p>
                                        }
                                    </td>
                                    <td class="tdPersonTable">
                                        <p class="text-muted">@person.Location.Name</p>
                                    </td>
                                    <td class="tdPersonTable">
                                        <p class="text-muted">@person.HireDate.ToString("dd.MM.yyyy")</p>
                                    </td>
                                    <td class="tdPersonTable">
                                        <p class="text-muted">@person.DismissalsDate?.ToString("dd.MM.yyyy")</p>
                                    </td>
                                    <td class="tdPersonTable">
                                        <p class="text-muted">@person.Entity?.Name</p>
                                    </td>
                                    <td class="tdPersonTable">
                                        <p class="text-muted">
                                            @{
                                                entityDict.TryGetValue(person.EntityCostGuid, out var ecName);
                                            }
                                            @ecName
                                        </p>
                                    </td>
                                    <td class="tdPersonTable">
                                        @if (person.Actual == 0)
                                        {
                                            <p class="text-muted">Уволен</p>
                                        }
                                        else if (person.Actual == 1)
                                        {
                                            <p class="text-muted">Активен</p>
                                        }
                                        else
                                        {
                                            <p class="text-muted">Отстранен</p>
                                        }
                                    </td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="paginationContainer"></div>

<script>
    var height = $('#global').height();
    height -= $('#cm-header').height();
    height -= $('#headMenu').height();
</script>

<!--инициализация таблицы-->
<script>
    // На время инициализации прячем, чтобы браузер меньше дёргался layout-ом
    var $wrap = $('#tableDataPerson').closest('.card-body');
    $wrap.css('visibility', 'hidden');

    var table = $(".data-table").DataTable({
        ordering: true,
        paging: true,
        pageLength: 18,
        order: [[0, 'asc']],      // вместо order+draw()

        searching: true,
        bLengthChange: false,
        destroy: true,
        info: false,

        // ускорители
        autoWidth: false,
        responsive: false,
        deferRender: true,

        scrollY: height,
        scrollCollapse: true,

        sDom: '<"row view-filter"<"col-sm-12"<"float-left"l><"float-right"f><"clearfix">>>t<"row view-pager"<"col-sm-12"<"text-center"ip>>>',
        language: {
            paginate: {
                first: '«',
                previous: '‹',
                next: '›',
                last: '»'
            }
        }
    });

    //переносим пагинацию один раз
    var paginate = $(table.table().container()).find('.dataTables_paginate').detach();
    $('#paginationContainer').append(paginate);

    //поиск по таблице
    $("#searchDatatable").on("keyup", function () {
        table.search($(this).val()).draw();
    });

    //скрываем сверху таблицы фильтры data-table
    $('.view-filter').hide();

    // возвращаем видимость
    $wrap.css('visibility', 'visible');
</script>

<!--клик по строке-->
<script>
    $('#buttonAdd').unbind('click');
    $('#buttonAdd').click(function () {
        AddItem(0, 1)
    });

    // Делегирование клика (вместо onclick на каждой строке)
    $('#tableDataPerson tbody').off('click', 'tr.activeRow');
    $('#tableDataPerson tbody').on('click', 'tr.activeRow', function () {
        PersonalityVersions(this.id, 0);
    });

    //поиск по таблице
    $("#personality_search").on("keyup", function () {
        table.search($(this).val()).draw();
    });

    $('#back').unbind('click');
    $('#back').click(function () { location.hash = "#staff" });
</script>
